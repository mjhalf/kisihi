<!DOCTYPE html>
<html lang="ko">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5E2YPZVR16"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5E2YPZVR16');
</script>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PRJ59GK8');</script>
<meta name="naver-site-verification" content="1eb2dceabf7e2908fb75bc78c9c7c3acade4bb51" />
<title>ë§ˆìš´ìë¡œ ì²´ë‚´ë†ë„ ê³„ì‚°ê¸° | mjhalf</title>
<meta name="description" content="ë‚´ ëª¸ì† ë§ˆìš´ìë¡œ ë†ë„ë¥¼ ê³„ì‚°í•˜ê³  ì²´ì¤‘ ë³€í™”ë¥¼ ê¸°ë¡í•˜ì„¸ìš”.">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta property="og:type" content="website">
<meta property="og:url" content="https://mjhalf.com">
<meta property="og:title" content="ë§ˆìš´ìë¡œ ì²´ë‚´ë†ë„ ê³„ì‚°ê¸° | mjhalf">
<meta property="og:description" content="ë‚´ ëª¸ì† ë§ˆìš´ìë¡œ ë†ë„ë¥¼ ê³„ì‚°í•˜ê³  ì²´ì¤‘ ë³€í™”ë¥¼ ê¸°ë¡í•˜ì„¸ìš”.">
<meta property="og:image" content="https://mjhalf.com/icon.png"> <meta property="og:site_name" content="KISIHI ë§ˆìš´ìë¡œ ë‹¤ì´ì–´ë¦¬">
<link rel="icon" type="image/png" href="icon.png">
<link rel="apple-touch-icon" href="icon.png"> 

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  /* 1. ê¸°ë³¸ ì´ˆê¸°í™” */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
   
  html, body { 
    height: 100%; margin: 0; padding: 0; 
    overflow: hidden; 
    background-color: #f0f2f5; 
    font-family: -apple-system, sans-serif;
  }

  /* 2. ì•± ì»¨í…Œì´ë„ˆ */
.app-container { 
    position: fixed; 
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%; max-width: 600px; 
    height: 100dvh; 
    margin: 0 auto; 
    background: white; 
    display: flex; flex-direction: column; 
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    z-index: 1;
    overflow: hidden; 
  }
   
/* ê´‘ê³  ì˜ì—­ ìŠ¤íƒ€ì¼ */
.ad-area { 
    width: 100%; 
    min-height: 50px; 
    flex-shrink: 0; 
    background: #fff; display: flex; justify-content: center; align-items: center; 
    border-bottom: 1px solid #eee; 
    z-index: 10;
  }
  .header { 
    height: 50px; 
    flex-shrink: 0; 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 0 15px; background: white; border-bottom: 1px solid #f8f9fa; 
    z-index: 20; position: relative;
  }
  .brand-name { font-weight: 900; color: #4f46e5; font-size: 1rem; }
  .menu-btn { font-size: 24px; cursor: pointer; padding: 5px; }

  /* 4. í˜ì´ì§€ ê³µí†µ */
.page { 
    display: none; 
    flex: 1; 
    width: 100%; 
    padding: 10px; 
    flex-direction: column; 
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch; 
    position: relative;
    z-index: 5;
  }
  .page.active { display: flex; }

  /* 5. ë‹¬ë ¥ í˜ì´ì§€ */
  #calendarPage { padding: 0; }
   
  #calendarContent {
    flex: 1; 
    display: flex; flex-direction: column;
    height: 100%; 
    padding: 0 5px 5px 5px; 
  }

  .day-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    padding: 5px 0;
    font-size: 0.8rem;
    font-weight: bold;
    color: #666;
    flex-shrink: 0; 
  }
  .day-header div:first-child { color: #ff4d4d; } 

  .cal-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    grid-template-rows: repeat(6, 1fr); 
    gap: 2px; 
    flex: 1; 
    height: 100%;
    min-height: 0; 
  }

  .cell { 
    width: 100%; height: 100%; 
    border-radius: 6px; border: 1px solid #f1f3f5; 
    position: relative; background: #fff; cursor: pointer; 
  }

  /* 6. ë¦¬í¬íŠ¸/êµ¬ì…ë‚´ì—­/ê²Œì‹œíŒ í˜ì´ì§€ */
  #reportPage, #historyPage, #boardPage {
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
  }

  /* 7. ê¸€ì”¨ ë° ë””ìì¸ ìš”ì†Œ */
  .num { position: absolute; top: 3px; left: 4px; font-size: 0.75rem; font-weight: bold; color: #333; }
  .holiday-red { color: #ff4d4d !important; }
  .status-icon { position: absolute; top: 3px; right: 3px; font-size: 0.8rem; }
   
  .weight-text { 
    position: absolute; top: 50%; left: 0; width: 100%; 
    transform: translateY(-50%); text-align: center; 
    font-weight: 600; color: #adb5bd; font-size: 0.7rem; 
  }
  .conc-text { 
    position: absolute; bottom: 3px; width: 100%; 
    text-align: center; font-weight: 700; color: #ba2b7e; font-size: 0.75rem; 
  }
  .injected { background-color: #ba2b7e !important; border-color: #ba2b7e !important; color: #fff !important; }
  .injected .num, .injected .weight-text, .injected .conc-text { color: #fff !important; }

  /* ë²„íŠ¼ ë° ëª¨ë‹¬ */
  .action-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; background: #4f46e5; color: white; cursor: pointer; margin-top: 5px; font-size: 1rem; }
  #menuOverlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 150; backdrop-filter: blur(2px); }
  .side-menu { position: absolute; top: 0; right: -260px; width: 260px; height: 100%; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.15); transition: 0.3s; z-index: 160; display: flex; flex-direction: column; }
  .side-menu.open { right: 0; }
  .menu-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: #fdfdfd; }
  .menu-content { flex: 1; overflow-y: auto; }
  .menu-item { padding: 16px 20px; border-bottom: 1px solid #f8f9fa; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
  .menu-item:active { background-color: #f5f5f5; }

/* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
.modal-overlay {
  display: none; 
  position: fixed; 
  top: 0; left: 0; 
  width: 100%; height: 100%; 
  background: rgba(0,0,0,0.4); 
  z-index: 2000; 
  justify-content: center; 
  align-items: center;
  backdrop-filter: blur(8px); 
  -webkit-backdrop-filter: blur(8px); 
}
  .modal { background: white; padding: 20px; border-radius: 25px; width: 320px; text-align: center; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
  .input-box { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #f1f3f5; box-sizing: border-box; font-size: 1rem; margin-bottom: 10px; outline: none; }
  .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
  .st-btn { border: 1px solid #f1f3f5; background: #f8f9fa; border-radius: 12px; padding: 12px 0; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
  .st-btn.active { border-color: #4f46e5; background: #f5f5ff; color: #4f46e5; }
  .h-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px; }
  .h-table th { background: #f8f9fa; padding: 10px; border-bottom: 2px solid #eee; }
  .h-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
  .icon-btn { cursor: pointer; font-size: 1rem; margin: 0 5px; }
  .c-2-5 { background-color: #8b8b8c !important; } .c-5 { background-color: #4f3672 !important; }
  .c-7-5 { background-color: #337e71 !important; } .c-10 { background-color: #ba2b7e !important; }

/* ê²Œì‹œíŒ ìŠ¤íƒ€ì¼ */
.board-item { padding: 15px; border-bottom: 1px solid #f1f3f5; cursor: pointer; background: white; text-align: left; }
.board-item:last-child { border-bottom: none; }
.notice-item { background-color: #fff9db !important; border-bottom: 1px solid #faecc5; }
.b-meta { font-size: 0.75rem; color: #999; margin-top: 5px; display: flex; justify-content: space-between; }
.admin-badge { background: #4f46e5; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
.comment-box { background: #f8f9fa; padding: 10px; border-radius: 10px; margin-top: 10px; text-align: left; font-size: 0.9rem; }
.reply-item { border-bottom: 1px solid #eee; padding: 8px 0; }
</style>
</head>
<body>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PRJ59GK8"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="app-container">
  <div class="ad-area" style="min-height: 50px;">
    <ins class="kakao_ad_area" style="display:none;"
      data-ad-unit = "DAN-5BcGjBzHapv0P7Aj"
      data-ad-width = "320"
      data-ad-height = "50"></ins>
    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
  </div>
   
  <div id="loginNotice" style="width:100%; text-align:center; color:#ff4d4d; font-size:0.75rem; font-weight:bold; background:white; padding-top:10px; display:none;">
    âš  ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
  </div>
   
<div class="header">
  <div class="brand-name" style="line-height: 1.1;">
    ë§ˆìš´ìë¡œ ì²´ë‚´ë†ë„ ê³„ì‚°ê¸°
    <div style="font-size: 0.65rem; color: #aaa; font-weight: normal; letter-spacing: 0.5px;">mjhalf.com</div>
  </div>
  <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
</div>

  <div id="calendarPage" class="page active">
    <div id="calendarContent">
      <div style="display:flex; justify-content:space-between; align-items:center; height:40px; flex-shrink:0;">
        <button onclick="moveCal(-1)" style="border:none; background:none; font-weight:bold; cursor:pointer; font-size:1.2rem; padding:0 10px;">â—€</button>
        <div id="calTitle" style="font-weight:900; font-size:1.1rem;"></div>
        <button onclick="moveCal(1)" style="border:none; background:none; font-weight:bold; cursor:pointer; font-size:1.2rem; padding:0 10px;">â–¶</button>
      </div>

      <div class="day-header">
        <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
      </div>
       
      <div class="cal-grid" id="calBoard"></div>
    </div>
  </div>

<div id="reportPage" class="page">
    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px; flex-shrink:0;">
      <button onclick="adjustRange(-7)" style="padding:8px 15px; border-radius:8px; border:1px solid #ddd; background:white;">-</button>
      <span id="dayRange" style="font-weight:bold; font-size:1rem; padding-top:8px;">14ì¼</span>
      <button onclick="adjustRange(7)" style="padding:8px 15px; border-radius:8px; border:1px solid #ddd; background:white;">+</button>
    </div>
    <div style="width: 100%; height: 40vh; min-height: 300px; position: relative; margin-bottom: 20px;">
      <canvas id="mainChart"></canvas>
    </div>
    <div id="reportSummary" style="background:#f8f9fa; border-radius:15px; padding:20px; font-size:0.9rem; line-height:1.8;">
        <div style="text-align:center; color:#999;">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
    </div>
  </div>
   
  <div id="pharmacyPage" class="page">
  <h3 style="padding:15px 0 5px 0; margin:0; color:#4f46e5; text-align: center;">ğŸ“ ì˜¨ëˆ„ë¦¬ ì•½êµ­ ì°¾ê¸°</h3>
  <div style="padding:0 0 15px 0; font-size:0.75rem; color:#999; text-align: center;">* ìì„¸í•œ ë‚´ìš©ì€ ì•½êµ­ìœ¼ë¡œ ì—°ë½í•˜ì„¸ìš” *</div>
   
  <div style="display: flex; flex-wrap: nowrap; gap: 3px; padding: 0 10px 15px 10px;">
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ì„œìš¸')">ì„œìš¸</button>
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ê²½ê¸°')">ê²½ê¸°ë„</button>
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ê°•ì›ë„')">ê°•ì›ë„</button>
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ì¶©ì²­ë„')">ì¶©ì²­ë„</button>
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ê²½ìƒë„')">ê²½ìƒë„</button>
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ì „ë¼ë„')">ì „ë¼ë„</button>
    <button class="st-btn" style="flex:1; min-width:0; padding:8px 0; font-size:0.75rem;" onclick="renderPharmList('ì œì£¼ë„')">ì œì£¼ë„</button>
  </div>

  <div id="pharmacyList" style="padding: 0 15px 20px 15px;">
    <div style="text-align:center; color:#999; margin-top:30px;">ì§€ì—­ì„ ì„ íƒí•˜ì‹œë©´ ì•½êµ­ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
  </div>
</div>

  <div id="historyPage" class="page">
    <button class="action-btn" onclick="openHModal()">+ êµ¬ì… ë‚´ì—­ ì¶”ê°€</button>
    <table class="h-table">
      <thead><tr><th>ë‚ ì§œ</th><th>ìš©ëŸ‰</th><th>ì´ì•¡</th><th>ê´€ë¦¬</th></tr></thead>
      <tbody id="hBody"></tbody>
    </table>
    <div id="hSummary" style="background:#f0f2ff; padding:12px; border-radius:15px; margin-top:10px; font-size:0.75rem; line-height:1.6;"></div>
  </div>

  <div id="boardPage" class="page">
    <div style="display:flex; gap:5px; margin-bottom:10px; padding:0 10px;">
        <input type="text" id="boardSearch" class="input-box" style="flex:1; margin:0;" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰" onkeyup="if(event.key==='Enter') loadBoard()">
        <button onclick="loadBoard()" style="background:#eee; border:none; border-radius:8px; padding:0 12px;">ğŸ”</button>
        <button id="writeBtn" onclick="openWriteModal()" style="background:#4f46e5; color:white; border:none; padding:8px 15px; border-radius:8px; font-size:0.85rem; cursor:pointer; display:none;">ê¸€ì“°ê¸°</button>
    </div>
    <div id="boardList" style="background:white; border-top:1px solid #eee; border-bottom:1px solid #eee;">
        </div>
    <div id="boardLoginMsg" style="text-align:center; padding:20px; color:#999; font-size:0.8rem; display:none;">
        ë¬¸ì˜ê¸€ì€ ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>
  </div>

  <div class="ad-area" style="min-height: 100px; border-top: 1px solid #eee; border-bottom: none;">
    <ins class="kakao_ad_area" style="display:none;"
      data-ad-unit = "DAN-hqgvX5lW7Fk7HWyY"
      data-ad-width = "320"
      data-ad-height = "100"></ins>
    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
  </div>

  <div id="sideMenu" class="side-menu">
    <div class="menu-header">
      <span style="font-weight:bold; color:#444;">ì „ì²´ ë©”ë‰´</span>
      <span onclick="toggleMenu()" style="cursor:pointer; font-size:1.5rem; color:#999;">&times;</span>
    </div>
    <div class="menu-content">
      <div id="authMenu" class="menu-item" onclick="openAuthModal()">
        <span>ğŸ‘¤</span> <span id="authText">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</span>
      </div>
      <div class="menu-item" onclick="showPage('calendar')"><span>ğŸ“…</span> ë‹¬ë ¥</div>
      <div class="menu-item" onclick="showPage('report')"><span>ğŸ“ˆ</span> ë¶„ì„ ë¦¬í¬íŠ¸</div>
      <div class="menu-item" onclick="showPage('history')"><span>ğŸ›’</span> êµ¬ì… ë‚´ì—­</div>
      <div id="pharmacyMenu" class="menu-item" onclick="handlePharmacyClick()"><span>ğŸ“</span> ì˜¨ëˆ„ë¦¬ ì•½êµ­ ì°¾ê¸°</div>
      <div class="menu-item" onclick="showPage('board')"><span>ğŸ“¢</span> ê³µì§€ & ë¬¸ì˜</div>
      <div class="menu-item" onclick="openInstallGuide()"><span>ğŸ“²</span> ìœ„ì ¯(í™ˆ í™”ë©´) ë§Œë“¤ê¸°</div>
      <div id="logoutBtn" class="menu-item" style="color:red; display:none;" onclick="handleLogout()">
        <span>ğŸšª</span> ë¡œê·¸ì•„ì›ƒ
      </div>
    </div>
  </div>
  <div id="menuOverlay" onclick="toggleMenu()"></div>

<div id="loginCheckModal" class="modal-overlay">
  <div class="modal">
    <h3 style="margin-top:0; color:#4f46e5;">ğŸ”’ ë¡œê·¸ì¸ í•„ìš”</h3>
    <p style="font-size:0.9rem; color:#666; line-height:1.6; margin-bottom: 20px;">
      ì˜¨ëˆ„ë¦¬ ìƒí’ˆê¶Œ 10% í• ì¸ ì•½êµ­ ì •ë³´ëŠ”<br>
      <b>ë¡œê·¸ì¸ í›„</b> í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
    <button class="action-btn" onclick="goToLogin()">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
    <button class="action-btn" style="background:#eee; color:#666; margin-top:10px;" onclick="closeLoginCheckModal()">ë‹«ê¸°</button>
  </div>
</div>

</div> 
<div id="authModal" class="modal-overlay">
  <div class="modal">
    <h3 id="authTitle" style="margin-top:0;">ë¡œê·¸ì¸</h3>
    <input type="email" id="emailIn" class="input-box" placeholder="ì´ë©”ì¼">
    <input type="password" id="pwIn" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <div id="signupOnly" style="display:none;">
      <input type="password" id="pwConfirm" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
    </div>
    <div id="loginOnly" style="text-align:left; margin-bottom:15px;">
      <label style="font-size:0.8rem; color:#666;"><input type="checkbox" id="autoLogin" checked> ìë™ ë¡œê·¸ì¸ ìœ ì§€</label>
    </div>
    <button class="action-btn" onclick="handleAuth()">í™•ì¸</button>
    <div id="authSwitch" style="font-size:0.75rem; color:#4f46e5; margin-top:15px; cursor:pointer;" onclick="switchAuth()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
    <button class="action-btn" style="background:#eee; color:#666; margin-top:10px;" onclick="closeAuthModal()">ì·¨ì†Œ</button>
  </div>
</div>


<div id="calModal" class="modal-overlay">
  <div class="modal">
    <div id="modalDate" style="font-weight:900; margin-bottom:15px; font-size:0.9rem;"></div>
    <input type="number" id="wInput" class="input-box" style="text-align:center;" placeholder="ì²´ì¤‘ (kg)" step="0.1">
    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:5px; margin-bottom:15px;">
      <div class="st-btn" id="st-ğŸ¤¢" onclick="setStat('ğŸ¤¢')">ëª»ë¨¹ê² ìŒ<br>ğŸ¤¢</div>
      <div class="st-btn" id="st-ğŸ˜Œ" onclick="setStat('ğŸ˜Œ')">í‰í™”ë¡œì›€<br>ğŸ˜Œ</div>
      <div class="st-btn" id="st-ğŸ¥¶" onclick="setStat('ğŸ¥¶')">ë°°ê³ í””<br>ğŸ¥¶</div>
    </div>
    <div class="btn-grid" id="doseGroup">
      <button class="st-btn c-2-5" onclick="setDose(2.5)">2.5</button>
      <button class="st-btn c-5" onclick="setDose(5)">5</button>
      <button class="st-btn c-7-5" onclick="setDose(7.5)">7.5</button>
      <button class="st-btn c-10" onclick="setDose(10)">10</button>
    </div>
    <button class="action-btn" onclick="saveCal()">ê¸°ë¡ ì €ì¥</button>
    <button class="action-btn" style="background:#eee; color:#666;" onclick="closeCalModal()">ì·¨ì†Œ</button>
  </div>
</div>

<div id="hModal" class="modal-overlay">
  <div class="modal">
    <h3 style="margin-top:0; font-size:0.9rem;">êµ¬ì… ê¸°ë¡ ğŸ›’</h3>
    <input type="hidden" id="editIdx" value="-1">
    <div style="display:grid; grid-template-columns: 1.2fr 1fr 1fr; gap:5px; margin-bottom:10px;">
      <select id="hYear" class="input-box" style="margin:0;"></select>
      <select id="hMonth" class="input-box" style="margin:0;"></select>
      <select id="hDay" class="input-box" style="margin:0;"></select>
    </div>
    <div class="btn-grid" id="hDoseGroup">
      <button class="st-btn" onclick="selHDose('2.5', this)">2.5</button>
      <button class="st-btn" onclick="selHDose('5', this)">5</button>
      <button class="st-btn" onclick="selHDose('7.5', this)">7.5</button>
      <button class="st-btn" onclick="selHDose('10', this)">10</button>
    </div>
    <div style="border-top:1px solid #eee; padding-top:10px; text-align:left;">
      <span style="font-size:0.75rem; font-weight:bold; color:#4f46e5;">[ì›ë‚´ì²˜ë°©]</span>
      <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
        <input type="number" id="inP" class="input-box" style="margin:0;" placeholder="ì›ë‚´ ê¸ˆì•¡" oninput="checkHType('in')">
        <label style="font-size:0.7rem; white-space:nowrap; cursor:pointer;"><input type="checkbox" id="inOn" onchange="calcHTotal()"> ì˜¨ëˆ„ë¦¬</label>
      </div>
    </div>
    <div style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; text-align:left;">
      <span style="font-size:0.75rem; font-weight:bold; color:#4f46e5;">[ì›ì™¸ì²˜ë°©]</span>
      <div style="display:flex; gap:5px; margin-top:5px;">
        <input type="number" id="hoP" class="input-box" placeholder="ë³‘ì›ë¹„" oninput="checkHType('out')">
        <label style="font-size:0.7rem; cursor:pointer;"><input type="checkbox" id="hoOn" onchange="calcHTotal()"> ì˜¨ëˆ„ë¦¬</label>
      </div>
      <div style="display:flex; gap:5px; margin-top:5px;">
        <input type="number" id="phP" class="input-box" placeholder="ì•½ê°’" oninput="checkHType('out')">
        <label style="font-size:0.7rem; cursor:pointer;"><input type="checkbox" id="phOn" onchange="calcHTotal()"> ì˜¨ëˆ„ë¦¬</label>
      </div>
    </div>
    <div style="margin-top:10px; font-weight:bold; color:#4f46e5;">ìµœì¢… í•©ê³„: <span id="hTotalDisplay">0</span>ì›</div>
    <button class="action-btn" onclick="saveH()">ì €ì¥</button>
    <button class="action-btn" style="background:#eee; color:#666;" onclick="closeHModal()">ì·¨ì†Œ</button>
  </div>
</div>

<div id="installModal" class="modal-overlay">
  <div class="modal" style="text-align: left;">
    <h3 style="margin-top:0; text-align:center;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸° ğŸ“²</h3>
    <p style="font-size:0.85rem; color:#666; text-align:center;">
      ì´ ì›¹ì•±ì„ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´<br><b>ì§„ì§œ ì•±ì²˜ëŸ¼</b> í¸í•˜ê²Œ ì“¸ ìˆ˜ ìˆì–´ìš”!
    </p>
    <div style="background:#f8f9fa; padding:10px; border-radius:10px; margin-bottom:10px;">
      <strong style="color:#4f46e5;">ğŸ ì•„ì´í° (Safari)</strong><br>
      <span style="font-size:0.8rem;">1. í•˜ë‹¨ ê³µìœ  ë²„íŠ¼ <span style="font-size:1.2rem;">âˆ</span> í´ë¦­<br>2. <b>'í™ˆ í™”ë©´ì— ì¶”ê°€'</b> ì„ íƒ</span>
    </div>
    <div style="background:#f8f9fa; padding:10px; border-radius:10px; margin-bottom:15px;">
      <strong style="color:#4f46e5;">ğŸ¤– ê°¤ëŸ­ì‹œ (Chrome/Samsung)</strong><br>
      <span style="font-size:0.8rem;">1. ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´ <span style="font-size:1.2rem;">â‹®</span> í´ë¦­<br>2. <b>'í™ˆ í™”ë©´ì— ì¶”ê°€'</b> ë˜ëŠ” <b>'ì•± ì„¤ì¹˜'</b> ì„ íƒ</span>
    </div>
    <button class="action-btn" style="background:#eee; color:#666;" onclick="document.getElementById('installModal').style.display='none'">ë‹«ê¸°</button>
  </div>
</div> 

<div id="writeModal" class="modal-overlay">
    <div class="modal" style="width:90%; height:90%; display:flex; flex-direction:column; max-width:600px;">
        <h3 style="margin-top:0;">ê¸€ì“°ê¸° âœï¸</h3>
        <input type="text" id="postTitle" class="input-box" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
        <textarea id="postContent" class="input-box" style="flex:1; resize:none; margin-bottom:10px;" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        
        <div id="adminOption" style="text-align:left; margin-bottom:10px; display:none;">
            <label style="font-weight:bold; color:#ff4d4d;">
                <input type="checkbox" id="isNotice"> ã…ê³µì§€ (ìƒë‹¨ ê³ ì •)
            </label>
        </div>
        <button class="action-btn" onclick="savePost()">ë“±ë¡</button>
        <button class="action-btn" style="background:#eee; color:#666;" onclick="document.getElementById('writeModal').style.display='none'">ì·¨ì†Œ</button>
    </div>
</div>

<div id="viewModal" class="modal-overlay">
    <div class="modal" style="width:90%; height:90%; text-align:left; display:flex; flex-direction:column; max-width:600px;">
        <div style="text-align:right;">
            <span onclick="document.getElementById('viewModal').style.display='none'" style="cursor:pointer; font-size:1.5rem;">&times;</span>
        </div>
        
        <div style="flex:1; overflow-y:auto; margin-bottom:10px; padding-right:5px;">
            <h3 id="viewTitle" style="margin:0 0 10px 0; color:#333;"></h3>
            <div id="viewContent" style="min-height:50px; white-space:pre-wrap; font-size:1rem; line-height:1.5; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;"></div>
            
            <div style="text-align:right; margin-bottom:10px;">
                <button id="editPostBtn" style="background:#4f46e5; color:white; border:none; padding:5px 10px; border-radius:5px; display:none; margin-right:5px;" onclick="editPost()">ìˆ˜ì •</button>
                <button id="delPostBtn" style="background:#ff4d4d; color:white; border:none; padding:5px 10px; border-radius:5px; display:none;" onclick="deletePost()">ì‚­ì œ</button>
            </div>

            <div style="border-top:1px solid #eee; padding-top:10px;">
                <strong style="font-size:0.85rem; color:#4f46e5;">ëŒ“ê¸€</strong>
                <div id="commentList" style="margin-top:10px;"></div>
            </div>
        </div>

        <div id="commentInputArea" style="border-top:1px solid #eee; padding-top:10px; display:none; flex-shrink:0;">
            <div style="display:flex; gap:5px;">
                <input type="text" id="commentInput" class="input-box" style="margin:0; font-size:0.85rem;" placeholder="ëŒ“ê¸€ ì‘ì„±...">
                <button onclick="saveComment()" style="border:none; background:#4f46e5; color:white; border-radius:8px; width:50px;">ë“±ë¡</button>
            </div>
        </div>
        <div id="loginMsg" style="text-align:center; font-size:0.8rem; color:#999; margin-top:10px; flex-shrink:0;">
            ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<script>
  let now = new Date();
  let injData = {}, weightData = {}, statData = {}, hData = [];
  let currentUser = null, supabaseClient = null;
  let selDate = "", selDose = null, selStat = null, selHDoseVal = "", myChart = null;
  let authMode = 'login'; 
  let globalPharmList = []; 
  let currentPostId = null; 
  let isEditMode = false; 
  let currentPostTitle = "";   
  let currentPostContent = ""; 
  const ADMIN_EMAIL = 'mjhalf@naver.com'; 
  let targetWeight = null; 
  let myCachedLocation = null; 

  window.onload = async () => {
    initHDate(); 
    drawCal();    

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => { myCachedLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude }; },
            (err) => { console.log("ìœ„ì¹˜ ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜"); },
            { enableHighAccuracy: false, timeout: 5000, maximumAge: 600000 } 
        );
    }

    if (window.supabase) {
      try {
        const SUPABASE_URL = 'https://raybetjpjyomeudmmncr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_8OEetEIuYXMH9l4xtd8vyg_Y9UgoJv3';
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
         
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
          currentUser = session.user;
          updateUI();
          loadFromDB();
        }
      } catch (e) { console.error("Supabase ì˜¤ë¥˜", e); }
    }
     
    loadPharmacies(); 
    updateUI(); 

    if (window.location.hash === '#map') {
        handlePharmacyClick();
    }
  };

  /* --- ë©”ë‰´ ë° í˜ì´ì§€ ì œì–´ --- */
  function toggleMenu() { 
    const sm = document.getElementById('sideMenu');
    const ov = document.getElementById('menuOverlay');
    if (sm && ov) {
      const isOpen = sm.classList.toggle('open');
      ov.style.display = isOpen ? 'block' : 'none';
    }
  }

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const target = document.getElementById(id + 'Page');
    if(target) target.classList.add('active');
     
    if (id === 'report') setTimeout(updateChart, 100);
    if (id === 'history') renderH();
    if (id === 'board') loadBoard(); 
     
    const sm = document.getElementById('sideMenu');
    if (sm.classList.contains('open')) toggleMenu();
  }

  /* --- ì˜¨ëˆ„ë¦¬ ì•½êµ­ ë¡œì§ --- */
  async function loadPharmacies() {
    try {
      const response = await fetch('pharmacy_list.csv?v=' + new Date().getTime()); 
      const data = await response.text();
      const rows = data.split('\n');
      const headers = rows[0].split(','); 
      globalPharmList = rows.slice(1).map(row => {
        const values = row.split(',');
        let obj = {};
        headers.forEach((header, i) => {
          if(header) obj[header.trim()] = values[i] ? values[i].trim() : "";
        });
        return obj;
      }).filter(p => p.name); 
    } catch (err) { console.error("CSV ë¡œë“œ ì‹¤íŒ¨", err); }
  }

  function handlePharmacyClick() {
    if (currentUser) {
      showPage('pharmacy');
    } else {
      const sm = document.getElementById('sideMenu');
      if(sm.classList.contains('open')) toggleMenu();
      document.getElementById('loginCheckModal').style.display = 'flex';
    }
  }

  function renderPharmList(region) {
    const listArea = document.getElementById('pharmacyList');
    
    const regionMap = {
        'ì„œìš¸': ['ì„œìš¸'],
        'ê²½ê¸°': ['ê²½ê¸°', 'ì¸ì²œ'],
        'ê°•ì›ë„': ['ê°•ì›'],
        'ì¶©ì²­ë„': ['ì¶©ì²­', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ëŒ€ì „', 'ì„¸ì¢…'],
        'ê²½ìƒë„': ['ê²½ìƒ', 'ê²½ë¶', 'ê²½ë‚¨', 'ëŒ€êµ¬', 'ë¶€ì‚°', 'ìš¸ì‚°'],
        'ì „ë¼ë„': ['ì „ë¼', 'ì „ë¶', 'ì „ë‚¨', 'ê´‘ì£¼'],
        'ì œì£¼ë„': ['ì œì£¼']
    };

    let targetKeywords = regionMap[region] || [region];
    let data = globalPharmList.filter(p => {
        return targetKeywords.some(keyword => p.area.includes(keyword));
    });

    if (data.length === 0) { 
        listArea.innerHTML = `<div style="text-align:center; color:#999; padding:30px;">${region} ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; 
        return; 
    }

    if (myCachedLocation) {
        processDistanceAndDraw(data, listArea, myCachedLocation.lat, myCachedLocation.lng);
    } 
    else {
        listArea.innerHTML = `<div style="text-align:center; padding:30px;">ğŸ“¡ ë‚´ ìœ„ì¹˜ í™•ì¸ ì¤‘...<br><span style="font-size:0.8rem; color:#999;">(ìµœì´ˆ 1íšŒë§Œ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤)</span></div>`;
        
        if (!navigator.geolocation) { 
            drawList(data, listArea, false); 
            return; 
        }

        navigator.geolocation.getCurrentPosition((pos) => {
            myCachedLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            processDistanceAndDraw(data, listArea, myCachedLocation.lat, myCachedLocation.lng);
        }, () => {
            drawList(data, listArea, false); 
        }, { timeout: 5000 });
    }
  }

  function processDistanceAndDraw(data, container, lat, lng) {
      data.forEach(p => { 
          p.distance = getDistanceFromLatLonInKm(lat, lng, parseFloat(p.lat), parseFloat(p.lng)); 
      });
      data.sort((a, b) => a.distance - b.distance);
      drawList(data, container, true);
  }

  function formatPrice(price) {
      if(!price) return "0";
      const num = Number(price);
      return isNaN(num) ? price : num.toLocaleString();
  }

  function drawList(data, container, showDistance) {
    let html = '';
    data.forEach(p => {
      const distBadge = showDistance && p.distance ? `<span style="color:#ba2b7e; font-weight:bold; font-size:0.85rem; margin-left:5px;">(${p.distance.toFixed(1)}km)</span>` : '';
      html += `
        <div style="background:white; border:1px solid #eee; border-radius:15px; padding:15px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
              <strong style="font-size:1.05rem; color:#333;">${p.name}</strong> 
              ${distBadge}<br>
              <span style="font-size:0.85rem; color:#666;">${p.add}</span><br>
              <span style="font-size:0.85rem; color:#666;">ğŸ“ ${p.call}</span>
            </div>
            <button onclick="window.open('${p.link}')" style="background:#fee500; border:none; padding:5px 10px; border-radius:8px; font-weight:bold; cursor:pointer;">ì¹´ì¹´ì˜¤ë§µ</button>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px;">
            <div style="flex:1; background:#f8f9fa; padding:8px; border-radius:8px; text-align:center;">
              <div style="font-size:0.7rem; color:#999;">2.5mg</div>
              <div style="font-size:0.9rem; font-weight:bold; color:#ba2b7e;">${formatPrice(p['25 price'])}</div>
            </div>
            <div style="flex:1; background:#f8f9fa; padding:8px; border-radius:8px; text-align:center;">
              <div style="font-size:0.7rem; color:#999;">5.0mg</div>
              <div style="font-size:0.9rem; font-weight:bold; color:#ba2b7e;">${formatPrice(p['5mg price'])}</div>
            </div>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }

  function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    if(!lat1 || !lon1 || !lat2 || !lon2) return 0;
    var R = 6371; 
    var dLat = deg2rad(lat2 - lat1);
    var dLon = deg2rad(lon2 - lon1);
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  function deg2rad(deg) { return deg * (Math.PI/180); }

  /* --- ì¸ì¦/ë¡œê·¸ì¸ ê´€ë ¨ --- */
  function closeLoginCheckModal() { document.getElementById('loginCheckModal').style.display = 'none'; }
  function goToLogin() { closeLoginCheckModal(); openAuthModal(); }
  function openAuthModal() { 
    authMode = 'login';
    document.getElementById('authTitle').innerText = 'ë¡œê·¸ì¸';
    document.getElementById('signupOnly').style.display = 'none';
    document.getElementById('loginOnly').style.display = 'block';
    document.getElementById('authModal').style.display = 'flex'; 
    const sm = document.getElementById('sideMenu');
    if(sm.classList.contains('open')) toggleMenu(); 
  }
  function switchAuth() {
    authMode = (authMode === 'login' ? 'signup' : 'login');
    document.getElementById('authTitle').innerText = (authMode === 'signup' ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸');
    document.getElementById('signupOnly').style.display = (authMode === 'signup' ? 'block' : 'none');
    document.getElementById('loginOnly').style.display = (authMode === 'signup' ? 'none' : 'block');
  }
  function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }
  async function handleAuth() {
    if (!supabaseClient) return alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
    const email = document.getElementById('emailIn').value;
    const password = document.getElementById('pwIn').value;
    if (authMode === 'signup') {
      const pwConfirm = document.getElementById('pwConfirm').value;
      if (password !== pwConfirm) return alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
      const { error } = await supabaseClient.auth.signUp({ email, password });
      if (error) alert(error.message); else { alert("ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); switchAuth(); }
    } else {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) alert(error.message); else { currentUser = data.user; closeAuthModal(); updateUI(); loadFromDB(); }
    }
  }
  async function handleLogout() {
    if(confirm("ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      if(supabaseClient) await supabaseClient.auth.signOut();
      currentUser = null; updateUI(); drawCal(); showPage('calendar'); alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  }

  function updateUI() {
    const authText = document.getElementById('authText'), authMenu = document.getElementById('authMenu');
    const logoutBtn = document.getElementById('logoutBtn'), notice = document.getElementById('loginNotice');
    
    const writeBtn = document.getElementById('writeBtn');
    const commentInput = document.getElementById('commentInputArea');
    const loginMsg = document.getElementById('loginMsg');
    const boardLoginMsg = document.getElementById('boardLoginMsg');
    
    if (currentUser) {
      authText.innerText = `${currentUser.email.split('@')[0]}ë‹˜`;
      authMenu.onclick = null; logoutBtn.style.display = 'flex'; if(notice) notice.style.display = 'none';
      if(writeBtn) writeBtn.style.display = 'block';
      if(commentInput) commentInput.style.display = 'block';
      if(loginMsg) loginMsg.style.display = 'none';
      if(boardLoginMsg) boardLoginMsg.style.display = 'none'; 
    } else {
      authText.innerText = `ë¡œê·¸ì¸ / íšŒì›ê°€ì…`;
      authMenu.onclick = openAuthModal; logoutBtn.style.display = 'none'; if(notice) notice.style.display = 'block';
      if(writeBtn) writeBtn.style.display = 'none';
      if(commentInput) commentInput.style.display = 'none';
      if(loginMsg) loginMsg.style.display = 'block';
      if(boardLoginMsg) boardLoginMsg.style.display = 'block'; 
    }
  }

  /* --- ê²Œì‹œíŒ ë¡œì§ --- */
  
  async function loadBoard() {
      const searchKey = document.getElementById('boardSearch').value.trim();
      let query = supabaseClient
        .from('board')
        .select('*')
        .is('parent_id', null) 
        .order('is_notice', { ascending: false }) 
        .order('created_at', { ascending: false });

      if (searchKey) {
          query = query.or(`title.ilike.%${searchKey}%,content.ilike.%${searchKey}%`);
      }

      const { data, error } = await query;
      const list = document.getElementById('boardList');
      list.innerHTML = '';
      if(error || !data) return;

      data.forEach(post => {
          const isNotice = post.is_notice;
          const isAdmin = post.email === ADMIN_EMAIL;
          const date = new Date(post.created_at).toLocaleDateString();
          let writer = post.email.split('@')[0];
          if (isAdmin) writer = `<span class="admin-badge">ğŸ‘‘ê´€ë¦¬ì</span> mjhalf(ìš´ì˜ì)`;
          
          const title = post.title || '(ì œëª© ì—†ìŒ)';

          list.innerHTML += `
            <div class="board-item ${isNotice ? 'notice-item' : ''}" onclick="viewPost(${post.id})">
                <div style="font-weight:bold; color:#333; font-size:1rem; margin-bottom:5px;">
                    ${isNotice ? '<span style="color:#ba2b7e;">[ê³µì§€]</span> ' : ''}${title}
                </div>
                <div class="b-meta">
                    <span>${writer}</span>
                    <span>${date}</span>
                </div>
            </div>`;
      });
  }

  function openWriteModal(isEdit = false) {
      if(!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      
      const adminOpt = document.getElementById('adminOption');
      if(currentUser.email === ADMIN_EMAIL) adminOpt.style.display = 'block';
      else adminOpt.style.display = 'none';

      if (!isEdit) {
          isEditMode = false;
          currentPostId = null;
          document.getElementById('postTitle').value = '';
          document.getElementById('postContent').value = '';
          document.getElementById('isNotice').checked = false;
      } else {
          isEditMode = true;
          document.getElementById('postTitle').value = currentPostTitle;
          document.getElementById('postContent').value = currentPostContent;
      }
      
      document.getElementById('writeModal').style.display = 'flex';
  }

  function editPost() {
      document.getElementById('viewModal').style.display = 'none';
      openWriteModal(true);
  }

  async function savePost() {
      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;
      if(!title.trim()) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if(!content.trim()) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      const isNotice = document.getElementById('isNotice').checked;

      let error;
      if (isEditMode) {
          const result = await supabaseClient.from('board').update({
              title: title,
              content: content
          }).eq('id', currentPostId);
          error = result.error;
      } else {
          const result = await supabaseClient.from('board').insert({
              user_id: currentUser.id,
              email: currentUser.email,
              title: title,
              content: content,
              is_notice: (currentUser.email === ADMIN_EMAIL && isNotice) 
          });
          error = result.error;
      }

      if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
      else {
          document.getElementById('writeModal').style.display = 'none';
          loadBoard();
      }
  }

  async function viewPost(id) {
      currentPostId = id;
      const { data, error } = await supabaseClient.from('board').select('*').eq('id', id).single();
      if(error) return alert('ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

      currentPostTitle = data.title || '';
      currentPostContent = data.content || '';

      document.getElementById('viewTitle').innerText = data.title || '(ì œëª© ì—†ìŒ)';
      document.getElementById('viewContent').innerText = data.content;
      
      const editBtn = document.getElementById('editPostBtn');
      const delBtn = document.getElementById('delPostBtn');
      
      if(currentUser && (currentUser.id === data.user_id || currentUser.email === ADMIN_EMAIL)) {
          editBtn.style.display = 'inline-block';
          delBtn.style.display = 'inline-block';
      } else {
          editBtn.style.display = 'none';
          delBtn.style.display = 'none';
      }

      document.getElementById('viewModal').style.display = 'flex';
      loadComments(id);
  }

  async function deletePost() {
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const { error } = await supabaseClient.from('board').delete().eq('id', currentPostId);
      if(error) alert('ì‚­ì œ ì‹¤íŒ¨');
      else {
          document.getElementById('viewModal').style.display = 'none';
          loadBoard();
      }
  }

  async function loadComments(postId) {
      const list = document.getElementById('commentList');
      list.innerHTML = '';
      const { data } = await supabaseClient
        .from('board')
        .select('*')
        .eq('parent_id', postId)
        .order('created_at', { ascending: true });

      if(data) {
          data.forEach(c => {
              const isAdmin = c.email === ADMIN_EMAIL;
              let writer = c.email.split('@')[0];
              if (isAdmin) writer = `<span class="admin-badge">ğŸ‘‘ê´€ë¦¬ì</span> ğŸ¦Š`; 

              let delBtn = '';
              if(currentUser && (currentUser.id === c.user_id || currentUser.email === ADMIN_EMAIL)) {
                  delBtn = `<span style="color:red; cursor:pointer; font-size:0.7rem; margin-left:5px;" onclick="deleteComment(${c.id})">x</span>`;
              }

              list.innerHTML += `
                <div class="reply-item">
                    <div style="font-size:0.8rem; font-weight:bold; color:#555;">${writer} ${delBtn}</div>
                    <div style="font-size:0.9rem;">${c.content}</div>
                </div>`;
          });
      }
  }

  async function saveComment() {
      const input = document.getElementById('commentInput');
      if(!input.value.trim()) return;
      
      const { error } = await supabaseClient.from('board').insert({
          user_id: currentUser.id,
          email: currentUser.email,
          content: input.value,
          parent_id: currentPostId 
      });

      if(error) alert('ëŒ“ê¸€ ì‹¤íŒ¨');
      else {
          input.value = '';
          loadComments(currentPostId);
      }
  }

  async function deleteComment(id) {
      if(!confirm('ëŒ“ê¸€ ì‚­ì œ?')) return;
      await supabaseClient.from('board').delete().eq('id', id);
      loadComments(currentPostId);
  }

  /* --- ë‹¬ë ¥/ê¸°ë¡ ë¡œì§ --- */
  function drawCal() {
    let y = now.getFullYear(), m = now.getMonth();
    const title = document.getElementById('calTitle'), board = document.getElementById('calBoard');
    if (!title || !board) return;
    title.innerText = `${y}ë…„ ${m + 1}ì›”`;
    board.innerHTML = "";
    let first = new Date(y, m, 1).getDay(), last = new Date(y, m + 1, 0).getDate();
    for(let e=0; e<first; e++) board.innerHTML += '<div></div>';
    for(let d=1; d<=last; d++) {
      let dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      let conc = 0; 
      for(let s in injData) { 
        let diff = Math.round((new Date(y,m,d) - new Date(s)) / 86400000); 
        if(diff >= 0) conc += injData[s] * Math.pow(0.5, diff/5); 
      }
      let cls = `cell ${injData[dStr] ? 'injected c-'+injData[dStr].toString().replace('.','-') : ''}`;
      board.innerHTML += `<div class="${cls}" onclick="openCalModal('${dStr}')">
          <span class="num ${new Date(y,m,d).getDay()===0?'holiday-red':''}">${d}</span>
          <span class="status-icon">${statData[dStr]||''}</span>
          <span class="weight-text">${weightData[dStr] ? weightData[dStr]+'kg' : ''}</span>
          <span class="conc-text">${conc > 0.1 ? conc.toFixed(1)+'mg' : ''}</span>
        </div>`;
    }
  }
  function moveCal(x) { now.setMonth(now.getMonth() + x); drawCal(); }
  function openCalModal(d) { selDate = d; document.getElementById('modalDate').innerText = d; document.getElementById('wInput').value = weightData[d] || ""; selDose = injData[d]; selStat = statData[d]; refreshCalUI(); document.getElementById('calModal').style.display = 'flex'; }
  function closeCalModal() { document.getElementById('calModal').style.display = 'none'; }
  function refreshCalUI() { document.querySelectorAll('#doseGroup .st-btn').forEach(b => b.style.opacity = b.innerText == selDose ? '1' : '0.3'); document.querySelectorAll('#calModal .st-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(selStat))); }
  function setDose(mg) { selDose = (selDose === mg) ? null : mg; refreshCalUI(); }
  function setStat(s) { selStat = (selStat === s) ? null : s; refreshCalUI(); }
  async function saveCal() { let w = parseFloat(document.getElementById('wInput').value); if(w) weightData[selDate] = w; else delete weightData[selDate]; if(selDose) injData[selDate] = selDose; else delete injData[selDate]; if(selStat) statData[selDate] = selStat; else delete statData[selDate]; drawCal(); closeCalModal(); if(currentUser) await saveToDB(); }

  /* --- êµ¬ì… ë‚´ì—­ / ë¦¬í¬íŠ¸ / DB --- */
  function initHDate() { const y=document.getElementById('hYear'), m=document.getElementById('hMonth'), d=document.getElementById('hDay'); if(!y) return; for(let i=2025;i<=2050;i++) y.innerHTML+=`<option value="${i}">${i}ë…„</option>`; for(let i=1;i<=12;i++) m.innerHTML+=`<option value="${i}">${i}ì›”</option>`; for(let i=1;i<=31;i++) d.innerHTML+=`<option value="${i}">${i}ì¼</option>`; y.value=now.getFullYear(); m.value=now.getMonth()+1; d.value=now.getDate(); }
  function openHModal(i=-1) { document.getElementById('hModal').style.display='flex'; document.getElementById('editIdx').value=i; }
  function closeHModal() { document.getElementById('hModal').style.display='none'; }
  function selHDose(v, b) { selHDoseVal = v; document.querySelectorAll('#hDoseGroup .st-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); }
  function checkHType(t) { if(t==='in'){ document.getElementById('hoP').value=''; document.getElementById('phP').value=''; } else { document.getElementById('inP').value=''; } calcHTotal(); }
  function calcHTotal() { let t=0, iP=Number(document.getElementById('inP').value), hP=Number(document.getElementById('hoP').value), pP=Number(document.getElementById('phP').value); if(iP>0) t=document.getElementById('inOn').checked?iP*0.9:iP; else t=(document.getElementById('hoOn').checked?hP*0.9:hP)+(document.getElementById('phOn').checked?pP*0.9:pP); document.getElementById('hTotalDisplay').innerText=Math.floor(t).toLocaleString(); return Math.floor(t); }
  async function saveH() { let date = `${document.getElementById('hYear').value}-${String(document.getElementById('hMonth').value).padStart(2,'0')}-${String(document.getElementById('hDay').value).padStart(2,'0')}`; let total = calcHTotal(); if(!selHDoseVal || total <= 0) return alert("ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”."); hData.push({date, dose: selHDoseVal, total}); hData.sort((a,b)=>new Date(a.date)-new Date(b.date)); renderH(); if(currentUser) await saveToDB(); closeHModal(); }
  
  function renderH() { 
    let b = document.getElementById('hBody'); 
    if(!b) return; 
    b.innerHTML=""; 
    let totalSum = 0;
    hData.forEach((item, i) => { 
        b.innerHTML+=`<tr><td>${item.date}</td><td>${item.dose}mg</td><td>${item.total.toLocaleString()}ì›</td><td><span onclick="delH(${i})">âŒ</span></td></tr>`; 
        totalSum += Number(item.total);
    }); 
    let s = document.getElementById('hSummary');
    if(s) {
        if(hData.length === 0) s.innerHTML = "ì•„ì§ ê¸°ë¡ëœ êµ¬ì… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.";
        else s.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold; color:#333;">ğŸ’° ì´ ì§€ì¶œ:</span><span style="font-weight:bold; font-size:1.1rem; color:#4f46e5;">${totalSum.toLocaleString()}ì›</span></div>`;
    }
  }

  async function saveToDB() { 
    if(!currentUser) return; 
    await supabaseClient.from('user_data').upsert({ 
        user_id: currentUser.id, 
        inj: injData, 
        weight: weightData, 
        stat: statData, 
        history: hData,
        target_weight: targetWeight 
    }); 
  }

  async function loadFromDB() { 
    const { data } = await supabaseClient.from('user_data').select('*').eq('user_id', currentUser.id).maybeSingle(); 
    if(data) { 
        injData = data.inj || {}; 
        weightData = data.weight || {}; 
        statData = data.stat || {}; 
        hData = data.history || []; 
        targetWeight = data.target_weight || null; 
        drawCal(); 
        if(document.getElementById('reportPage').classList.contains('active')) updateChart();
    } 
  }

  async function saveGoal(val) {
    targetWeight = parseFloat(val);
    updateChart(); 
    if(currentUser) await saveToDB();
  }

  function adjustRange(v) { let r=document.getElementById('dayRange'); let val=parseInt(r.innerText)+v; if(val<7) val=7; r.innerText=val+"ì¼"; updateChart(); }

  /* í•µì‹¬ ë¡œì§: ë¶„ì„ ë¦¬í¬íŠ¸ ì—…ë°ì´íŠ¸ (ì „ì²´ ì½”ë“œ) */
function updateChart() {
  const ctx = document.getElementById('mainChart').getContext('2d');
  const range = parseInt(document.getElementById('dayRange').innerText);
  
  // 1. ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
  let labels = []; let wData = []; let cData = [];
  let start = new Date(); start.setDate(start.getDate() - (range - 1));
  
  // ìš”ì¼ë³„ & ë†ë„ë³„ ë°ì´í„° ìˆ˜ì§‘ìš© ì´ˆê¸°í™”
  let bucketData = {}; 
  let maxConcFound = 0;
  let dayOfWeekData = { 0: { sum: 0, count: 0 }, 1: { sum: 0, count: 0 }, 2: { sum: 0, count: 0 }, 3: { sum: 0, count: 0 }, 4: { sum: 0, count: 0 }, 5: { sum: 0, count: 0 }, 6: { sum: 0, count: 0 } };

  for (let i = 0; i < range; i++) {
      let d = new Date(start); d.setDate(d.getDate() + i);
      let dStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      labels.push(`${d.getMonth()+1}/${d.getDate()}`);
      wData.push(weightData[dStr] || null);
      
      let conc = 0;
      for(let s in injData) {
          let injDate = new Date(s);
          let diff = (d - injDate) / (1000 * 60 * 60 * 24);
          if (diff >= 0) conc += injData[s] * Math.pow(0.5, diff/5);
      }
      cData.push(conc.toFixed(2));
  }

  // 2. í†µê³„ ë°ì´í„° ë¶„ì„ (ì „ì²´ ê¸°ê°„ ë£¨í”„)
  const allDates = Object.keys(weightData).sort();
  for (let i = 0; i < allDates.length - 1; i++) {
      const d1Str = allDates[i], d2Str = allDates[i+1];
      const d1 = new Date(d1Str), d2 = new Date(d2Str);
      
      if ((d2 - d1) / (1000 * 60 * 60 * 24) === 1) {
          const dailyWeightChange = weightData[d1Str] - weightData[d2Str]; 
          
          let currentConc = 0;
          for(let s in injData) {
              let diff = (d1 - new Date(s)) / (1000 * 60 * 60 * 24);
              if(diff >= 0) currentConc += injData[s] * Math.pow(0.5, diff/5);
          }
          if(currentConc > maxConcFound) maxConcFound = currentConc;

          // ë†ë„ë³„ ë²„í‚·
          let bucket = Math.floor(currentConc); 
          if (!bucketData[bucket]) bucketData[bucket] = { sum: 0, count: 0 };
          bucketData[bucket].sum += dailyWeightChange;
          bucketData[bucket].count++;

          // ìš”ì¼ë³„ ë°ì´í„°
          let day = d1.getDay();
          dayOfWeekData[day].sum += dailyWeightChange;
          dayOfWeekData[day].count++;
      }
  }

  // 3. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
  const validWeights = wData.filter(w => w !== null);
  const minWeight = validWeights.length > 0 ? Math.min(...validWeights) : 0;
  const yMin = minWeight > 2 ? Math.floor(minWeight - 2) : 0;
  if (myChart) myChart.destroy();
  myChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: labels,
          datasets: [
              { label: 'ì²´ì¤‘ (kg)', data: wData, borderColor: '#4f46e5', backgroundColor: '#4f46e5', yAxisID: 'y', spanGaps: true, tension: 0.1, pointRadius: 0, pointHoverRadius: 0, fill: false },
              { label: 'ì²´ë‚´ ë†ë„ (mg)', data: cData, borderColor: '#ba2b7e', backgroundColor: '#ba2b7e', yAxisID: 'y1', tension: 0.4, pointRadius: 0, pointHoverRadius: 0, fill: false }
          ]
      },
      options: {
          responsive: true, maintainAspectRatio: false, events: [],
          scales: {
              y: { type: 'linear', display: true, position: 'left', min: yMin, title: { display: true, text: 'ì²´ì¤‘', color: '#4f46e5', font: { weight: 'bold' } }, ticks: { color: '#4f46e5', stepSize: 1, callback: function(value) { return Math.floor(value); } } },
              y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'ë†ë„', color: '#ba2b7e', font: { weight: 'bold' } }, ticks: { color: '#ba2b7e', stepSize: 5 }, min: 0, max: 30 }
          },
          plugins: { tooltip: { enabled: false }, legend: { display: true } }
      }
  });

  // 4. ë¦¬í¬íŠ¸ HTML ìƒì„±
  const summaryDiv = document.getElementById('reportSummary');
  if (allDates.length > 0) {
      const startWeight = weightData[allDates[0]], currentWeight = weightData[allDates[allDates.length - 1]];
      const daysPassed = Math.ceil((new Date() - new Date(allDates[0])) / 86400000) + 1;
      const totalLoss = startWeight - currentWeight, dailyLoss = totalLoss / daysPassed;

      // ë¹„ìš© ê³„ì‚°
      let totalCostUsed = 0, costPerDay = 0, inventory = {}, lastPrices = {};
      let sortedHistory = [...hData].sort((a, b) => new Date(a.date) - new Date(b.date));
      sortedHistory.forEach(record => {
          let doseKey = record.dose.toString(), pricePerPen = Number(record.total) / 4;
          if (!inventory[doseKey]) inventory[doseKey] = [];
          for(let k=0; k<4; k++) inventory[doseKey].push(pricePerPen);
          lastPrices[doseKey] = pricePerPen;
      });
      let todayCheck = new Date(); todayCheck.setHours(23, 59, 59, 999);
      let sortedInjDates = Object.keys(injData).sort().filter(dStr => new Date(dStr) <= todayCheck);
      sortedInjDates.forEach(date => {
          let usedDose = injData[date].toString();
          if (inventory[usedDose] && inventory[usedDose].length > 0) totalCostUsed += inventory[usedDose].shift();
          else if (lastPrices[usedDose]) totalCostUsed += lastPrices[usedDose];
      });
      let calcEndDate = new Date();
      if (sortedInjDates.length > 0) {
          let dietEndDate = new Date(sortedInjDates[sortedInjDates.length - 1]);
          dietEndDate.setDate(dietEndDate.getDate() + 14);
          if (new Date() > dietEndDate) calcEndDate = dietEndDate;
      }
      calcEndDate.setHours(0,0,0,0);
      let sDateCost = new Date(allDates[0]); sDateCost.setHours(0,0,0,0);
      let costDays = Math.ceil((calcEndDate - sDateCost) / 86400000) + 1;
      if(costDays < 1) costDays = 1;
      costPerDay = totalCostUsed / costDays;

      // ëª©í‘œ ì˜ˆì¸¡ HTML
      let predictionHtml = `<span style="color:#999; font-size:0.8rem;">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</span>`;
      let projectedCostHtml = `<span style="color:#999; font-size:0.8rem;">-</span>`;
      if (targetWeight) {
          const remainingLoss = currentWeight - targetWeight;
          if (remainingLoss <= 0) {
              predictionHtml = `<span style="color:#4f46e5; font-weight:bold;">ğŸ‰ ì´ë¯¸ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!</span>`;
              projectedCostHtml = `<span style="color:#4f46e5; font-weight:bold;">0ì›</span>`;
          } else if (dailyLoss <= 0) {
              predictionHtml = `<span style="color:#ff4d4d; font-weight:bold;">ì²´ì¤‘ì´ ëŠ˜ê³  ìˆì–´ìš” ğŸ¥²</span>`;
              projectedCostHtml = `<span style="color:#999;">ê³„ì‚° ë¶ˆê°€</span>`;
          } else {
              const daysNeeded = Math.ceil(remainingLoss / dailyLoss);
              const targetDate = new Date(); targetDate.setDate(targetDate.getDate() + daysNeeded);
              predictionHtml = `<span style="color:#ba2b7e; font-weight:bold;">${targetDate.getFullYear()}ë…„ ${targetDate.getMonth() + 1}ì›” ${targetDate.getDate()}ì¼ (ì•½ ${daysNeeded}ì¼ í›„)</span>`;
              if (totalLoss > 0) projectedCostHtml = `<span style="color:#ba2b7e; font-weight:bold;">ì•½ ${Math.round((totalCostUsed / totalLoss) * remainingLoss).toLocaleString()}ì›</span>`;
              else projectedCostHtml = `<span style="color:#999;">ê°ëŸ‰ ë°ì´í„° ë¶€ì¡±</span>`;
          }
      }

      // ë†ë„ë³„ ë¶„ì„ HTML
      let efficiencyHtml = "";
      let limit = Math.ceil(maxConcFound) || 1;
      for (let i = 0; i < limit; i++) {
          if (bucketData[i] && bucketData[i].count > 0) {
              let avg = bucketData[i].sum / bucketData[i].count;
              efficiencyHtml += `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee; font-size:0.8rem;"><span>ğŸ§ª ${i}~${i+1}mg êµ¬ê°„</span><span style="font-weight:bold; color:${avg >= 0 ? '#4f46e5' : '#ff4d4d'};">${avg >= 0 ? '-' : '+'}${Math.abs(avg).toFixed(2)}kg/ì¼</span></div>`;
          }
      }

      // ìš”ì¼ë³„ ë¶„ì„ HTML
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      let dayEfficiencyHtml = `<div style="display:flex; justify-content:space-between; text-align:center; padding:5px 0;">`;
      for (let i = 0; i < 7; i++) {
          let avg = dayOfWeekData[i].count > 0 ? dayOfWeekData[i].sum / dayOfWeekData[i].count : 0;
          let color = avg > 0 ? '#4f46e5' : (avg < 0 ? '#ff4d4d' : '#999');
          dayEfficiencyHtml += `<div style="flex:1;"><div style="font-size:0.7rem; color:#666;">${dayNames[i]}</div><div style="font-size:0.75rem; font-weight:bold; color:${color};">${avg === 0 ? '-' : (avg > 0 ? '-' : '+') + Math.abs(avg).toFixed(2)}</div></div>`;
      }
      dayEfficiencyHtml += `</div>`;

      // [ì¶”ê°€ë¨] ì£¼ì‚¬ íšŒì°¨ë³„ ìƒì„¸ ë¶„ì„ í‘œ ìƒì„±
      let fullInjDates = Object.keys(injData).sort();
      let cycleTableHtml = `
          <div style="margin-top:10px; background:white; border-radius:12px; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.03);">
              <div style="font-weight:bold; color:#4f46e5; margin-bottom:10px; text-align:center;">ğŸ’‰ ì£¼ì‚¬ íšŒì°¨ë³„ ìƒì„¸ ê¸°ë¡</div>
              <table style="width:100%; border-collapse:collapse; font-size:0.75rem; text-align:center; table-layout: fixed;">
                  <thead style="background:#f8f9fa; border-bottom:2px solid #eee;">
                      <tr>
                          <th style="padding:8px 0; color:#666; width:10%;">No</th>
                          <th style="padding:8px 0; color:#666; width:20%;">ë‚ ì§œ</th>
                          <th style="padding:8px 0; color:#666; width:15%;">mg</th>
                          <th style="padding:8px 0; color:#666; width:15%;">ê¸°ê°„</th>
                          <th style="padding:8px 0; color:#666; width:20%;">ê°ëŸ‰</th>
                          <th style="padding:8px 0; color:#666; width:20%;">í‰ê· </th>
                      </tr>
                  </thead>
                  <tbody>`;
      
      for (let i = 0; i < fullInjDates.length; i++) {
          let dateStr = fullInjDates[i];
          let nextDateStr = (i < fullInjDates.length - 1) ? fullInjDates[i+1] : null;
          let dose = injData[dateStr];
          
          let sDate = new Date(dateStr);
          let eDate = nextDateStr ? new Date(nextDateStr) : new Date(); 
          sDate.setHours(0,0,0,0); eDate.setHours(0,0,0,0);
          
          let duration = Math.ceil((eDate - sDate) / (1000 * 60 * 60 * 24));
          if (i === fullInjDates.length - 1 && duration < 1) duration = 1;

          let startW = weightData[dateStr];
          let sortedW = Object.keys(weightData).sort();
          let endW = nextDateStr ? weightData[nextDateStr] : weightData[sortedW[sortedW.length-1]]; 
          
          let lossText = "-", effText = "-";
          if (startW && endW) {
              let loss = startW - endW;
              let eff = loss / duration;
              let color = loss >= 0 ? '#4f46e5' : '#ff4d4d';
              let sign = loss >= 0 ? '-' : '+';
              lossText = `<span style="color:${color}; font-weight:bold;">${sign}${Math.abs(loss).toFixed(1)}</span>`;
              effText = `<span style="color:#666;">${sign}${Math.abs(eff).toFixed(2)}</span>`;
          }

          cycleTableHtml += `
              <tr style="border-bottom:1px solid #f1f3f5;">
                  <td style="padding:10px 0;">${i + 1}</td>
                  <td style="padding:10px 0;">${sDate.getMonth()+1}.${sDate.getDate()}</td>
                  <td style="padding:10px 0;">${dose}</td>
                  <td style="padding:10px 0;">${duration}ì¼</td>
                  <td style="padding:10px 0;">${lossText}</td>
                  <td style="padding:10px 0;">${effText}</td>
              </tr>`;
      }
      cycleTableHtml += `</tbody></table></div>`;

      // ìµœì¢… ì¶œë ¥ (ìˆœì„œ: ìš”ì•½ -> ìš”ì¼ë³„ -> ë†ë„ë³„ -> ë¹„ìš©/ëª©í‘œ -> ì£¼ì‚¬ê¸°ë¡í‘œ)
      summaryDiv.innerHTML = `
          <div style="padding:15px; background:white; border-radius:12px; margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between;"><span>ê²½ê³¼ ë‚ ì§œ</span><b>${daysPassed}ì¼</b></div>
              <div style="display:flex; justify-content:space-between;"><span>ì´ ê°ëŸ‰</span><b style="color:#4f46e5;">-${totalLoss.toFixed(1)}kg</b></div>
          </div>
          <div style="padding:15px; background:white; border-radius:12px; margin-bottom:10px;">
              <div style="font-weight:bold; color:#ba2b7e; margin-bottom:10px; text-align:center;">ğŸ“… ìš”ì¼ë³„ í‰ê·  ê°ëŸ‰ (kg)</div>
              ${dayEfficiencyHtml}
          </div>
          <div style="padding:15px; background:white; border-radius:12px; margin-bottom:10px;">
              <div style="font-weight:bold; color:#4f46e5; margin-bottom:10px; text-align:center;">ğŸ“Š ì²´ë‚´ ë†ë„ë³„ í‰ê·  ê°ëŸ‰</div>
              ${efficiencyHtml || '<div style="text-align:center; color:#999; font-size:0.8rem;">ë°ì´í„° ë¶„ì„ ì¤‘...</div>'}
          </div>
          <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #ddd;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>ğŸ’¸ ì´ ë¹„ìš©:</span><span style="font-weight:bold; color:#333;">${Math.round(totalCostUsed).toLocaleString()}ì›</span></div>
              <div style="display:flex; justify-content:space-between;"><span>ğŸ’° ì¼ ë¹„ìš©:</span><span style="font-weight:bold; color:#ba2b7e;">${Math.round(costPerDay).toLocaleString()}ì›</span></div>
          </div>
          <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #ddd;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                  <span style="font-weight:bold; color:#333;">ğŸ ëª©í‘œ:</span>
                  <input type="number" value="${targetWeight || ''}" placeholder="0" style="width:60px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:8px; font-weight:bold; color:#4f46e5;" onchange="saveGoal(this.value)"> kg
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><span style="font-weight:bold; color:#333;">ğŸ”® ì˜ˆìƒì¼:</span>${predictionHtml}</div>
              <div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold; color:#333;">ğŸ’³ ì˜ˆìƒë¹„ìš©:</span>${projectedCostHtml}</div>
          </div>
          ${cycleTableHtml}
      `;
  } else {
      summaryDiv.innerHTML = `<div style="text-align:center; color:#999;">ì²´ì¤‘ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }
}


  function openInstallGuide() { document.getElementById('installModal').style.display='flex'; toggleMenu(); }
</script>
</body>
</html>